<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聞き取り第4回：The Water Cycle & Sediment Transport（修正版）</title>
    <style>
        body {
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
            background-color: #f4f4f9;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        /* 追加した戻るボタンのスタイル */
        .back-link-btn {
            display: inline-block;
            margin-bottom: 15px;
            padding: 8px 16px;
            background-color: #95a5a6;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 0.9em;
            transition: background-color 0.2s;
        }
        .back-link-btn:hover {
            background-color: #7f8c8d;
        }
        .video-info {
            text-align: center;
            margin-bottom: 30px;
            padding: 10px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .question-card {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .q-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .q-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #2980b9;
        }
        .play-link-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            cursor: pointer;
            padding: 6px 15px;
            border-radius: 4px;
            font-size: 0.9em;
            display: inline-block;
            transition: background-color 0.2s;
            text-decoration: none;
        }
        .play-link-btn:hover {
            background-color: #c0392b;
        }
        /* 埋め込み失敗時の予備リンク */
        .fallback-link {
            font-size: 0.8em;
            color: #e74c3c;
            margin-left: 10px;
            text-decoration: underline;
            cursor: pointer;
        }
        .theme-text {
            font-size: 0.95em;
            color: #555;
            margin-bottom: 15px;
            background: #f0f8ff;
            padding: 10px;
            border-left: 4px solid #3498db;
        }
        textarea {
            width: 100%;
            height: 80px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1em;
            box-sizing: border-box;
            resize: vertical;
            font-family: inherit;
        }
        .controls {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .check-btn {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
        }
        .check-btn:hover {
            background-color: #219150;
        }
        .result-area {
            margin-top: 15px;
            padding: 15px;
            border: 1px solid #ddd;
            background-color: #fafafa;
            border-radius: 4px;
            display: none;
            line-height: 1.6;
        }
        .diff-word { margin: 0 2px; }
        .correct-word { color: #27ae60; font-weight: bold; }
        .wrong-word { color: #c0392b; text-decoration: line-through; margin-right: 4px; }
        .missing-word { color: #2980b9; font-weight: bold; border-bottom: 2px solid #2980b9; }
        .perfect { color: #27ae60; font-weight: bold; font-size: 1.2em; }
        .translation-toggle { font-size: 0.85em; color: #7f8c8d; cursor: pointer; text-decoration: underline; }
        .japanese-trans { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #eee; font-size: 0.9em; color: #555; display: none; }
        .embedded-video-container { margin-top: 10px; margin-bottom: 10px; display: none; background: #000; border-radius: 4px; overflow: hidden; }
    </style>
</head>
<body>

    <a href="index.html" class="back-link-btn">← 一覧に戻る</a>
    <h1>聞き取り第4回：The Water Cycle & Sediment Transport</h1>
    
    <div class="video-info">
        <p>※ 再生できない場合は「別タブで開く」をつかってください。</p>
    </div>

    <div id="quiz-container"></div>

    <script>
        const VIDEO_ID = "LGpNXsAxqv4";
        // YouTubeのドメインをnocookieに変更
        const EMBED_BASE = "https://www.youtube-nocookie.com/embed/";

        // 第4回のデータ
        const quizData = [
            {
                id: 1,
                timeDisplay: "00:28 ～ 00:35",
                startSeconds: 28,
                theme: "水循環（Water Cycle）の始まりについて",
                correct: "To look at the water cycle, we can start from the sea where water evaporates and is taken over by the overlying air masses.",
                translation: "水循環を見るために、水が蒸発し、上空の大気の塊（気団）に取り込まれる海から話を始めましょう。"
            },
            {
                id: 2,
                timeDisplay: "02:21 ～ 02:30",
                startSeconds: 141,
                theme: "川の運搬能力（Carrying capacity）の定義と決定要因について",
                correct: "The carrying capacity is a measure of the amount of sediments transported by the river and of the grain size it can carry. Carrying capacity is primarily dependent on the velocity of the water flow.",
                translation: "運搬能力（Carrying capacity）とは、川が運搬する堆積物の量と、運搬できる粒子サイズの尺度です。運搬能力は、主に水流の速度に依存します。"
            },
            {
                id: 3,
                timeDisplay: "03:56 ～ 04:08",
                startSeconds: 236,
                theme: "ユルストローム図（Hjulstrom diagram）の役割について",
                correct: "A way to link the speed of the water flow with erosion, transport, or sedimentation is the Hjulstrom diagram in which the velocity of the flowing water is plotted against the grains size.",
                translation: "水流の速度を侵食、運搬、または堆積と結びつける方法の一つがユルストローム図（Hjulström diagram）であり、そこでは流れる水の速度が粒子のサイズに対してプロットされています。"
            },
            {
                id: 4,
                timeDisplay: "05:15 ～ 05:29",
                startSeconds: 315,
                theme: "川の流速が急激に低下した場合の現象（堆積）について",
                correct: "Imagine that a river loaded with all possible grain sizes and flowing at 800cm per second suddenly decreases its speed to 60-70cm per second. Then it will dump most of the sediments and will only carry grain sizes smaller than 0.05 mm.",
                translation: "あらゆるサイズの粒子を含み、秒速800cmで流れていた川が、突然その速度を秒速60〜70cmに落としたと想像してください。すると、堆積物の大部分を放出し、0.05mmより小さい粒子サイズのみを運ぶようになります。"
            },
            {
                id: 5,
                timeDisplay: "06:54 ～ 07:04",
                startSeconds: 414,
                theme: "氷河による堆積物の運搬（ベルトコンベアのような動き）について",
                correct: "The ice will keep on moving from the high to the low altitudes constantly carrying sediments off scraped from the bottom and the sides of the valley to the front like a conveyor belt.",
                translation: "氷は高地から低地へと動き続け、谷底や側面から削り取られた堆積物を、コンベアベルトのように絶えず前線へと運びます。"
            }
        ];

        const container = document.getElementById('quiz-container');
        
        quizData.forEach((q, index) => {
            // 別タブ用の通常リンク
            const directLink = `https://youtu.be/${VIDEO_ID}?t=${q.startSeconds}`;

            const html = `
                <div class="question-card">
                    <div class="q-header">
                        <span class="q-title">第${q.id}問 (${q.timeDisplay})</span>
                        <div class="theme-text">
                            <strong>テーマ:</strong> ${q.theme}
                        </div>
                        <br>
                        <div>
                            <a href="${directLink}" target="_blank" class="fallback-link">別タブで開く</a>
                        </div>
                    </div>
                    
                    <div id="video-area-${index}" class="embedded-video-container"></div>

                    <div>
                        <button class="play-link-btn" onclick="playEmbeddedVideo(${index}, ${q.startSeconds})">▶ 埋め込み再生</button>
                        <br>
                        <textarea id="input-${index}" placeholder="ここに英語の文章を入力してください..."></textarea>
                    </div>
                    <div class="controls">
                        <button class="check-btn" onclick="checkAnswer(${index})">答え合わせ</button>
                        <span class="translation-toggle" onclick="toggleTrans(${index})">日本語訳を表示/非表示</span>
                    </div>
                    <div id="result-${index}" class="result-area"></div>
                    <div id="trans-${index}" class="japanese-trans">
                        <strong>日本語訳:</strong><br>${q.translation}
                    </div>
                </div>
            `;
            container.innerHTML += html;
        });

        function playEmbeddedVideo(index, startSeconds) {
            quizData.forEach((_, i) => {
                const area = document.getElementById(`video-area-${i}`);
                if (i !== index) {
                    area.innerHTML = "";
                    area.style.display = "none";
                }
            });

            const targetArea = document.getElementById(`video-area-${index}`);
            targetArea.style.display = "block";
            
            // 自動再生は削除(autoplay=1 -> 0)し、nocookieドメインを使用
            targetArea.innerHTML = `
                <iframe 
                    width="100%" 
                    height="150" 
                    src="${EMBED_BASE}${VIDEO_ID}?start=${startSeconds}" 
                    frameborder="0" 
                    allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                    allowfullscreen>
                </iframe>
                <div style="text-align:center; font-size:0.8em; color:#666; margin-top:5px;">
                    ※再生ボタンを押してください。それでもエラーが出る場合は「別タブで開く」をご利用ください。
                </div>
            `;
        }

        function toggleTrans(index) {
            const el = document.getElementById(`trans-${index}`);
            el.style.display = (el.style.display === 'block') ? 'none' : 'block';
        }

        function checkAnswer(index) {
            const userText = document.getElementById(`input-${index}`).value.trim();
            const correctText = quizData[index].correct;
            const resultDiv = document.getElementById(`result-${index}`);
            if (!userText) {
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = '<span style="color:red;">テキストを入力してください。</span>';
                return;
            }
            if (userText === correctText) {
                resultDiv.innerHTML = '<div class="perfect">正解です！ Perfect!</div>';
                resultDiv.style.display = 'block';
                return;
            }
            let html = "<strong>判定結果:</strong><br>";
            html += generateDiffHTML(userText, correctText);
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = html;
        }

        function generateDiffHTML(userStr, correctStr) {
            const clean = s => s.toLowerCase().replace(/[.,?!;:"'’]/g, "");
            const userWords = userStr.split(/\s+/);
            const correctWords = correctStr.split(/\s+/);
            let output = "<div>";
            let uIndex = 0;
            for (let i = 0; i < correctWords.length; i++) {
                let cWord = correctWords[i];
                let cWordClean = clean(cWord);
                if (uIndex >= userWords.length) {
                    output += `<span class="diff-word missing-word" title="正解: ${cWord}">${cWord}</span> `;
                    continue;
                }
                let uWord = userWords[uIndex];
                let uWordClean = clean(uWord);
                if (cWordClean === uWordClean) {
                    output += `<span class="diff-word correct-word">${cWord}</span> `;
                    uIndex++;
                } else {
                    let nextUMatch = (uIndex + 1 < userWords.length) && (clean(userWords[uIndex+1]) === cWordClean);
                    if (nextUMatch) {
                        output += `<span class="diff-word wrong-word">${uWord}</span> `;
                        output += `<span class="diff-word correct-word">${cWord}</span> `;
                        uIndex += 2; 
                    } else {
                        output += `<span class="diff-word wrong-word">${uWord}</span> `;
                        output += `<span class="diff-word missing-word">${cWord}</span> `;
                        uIndex++;
                    }
                }
            }
            while(uIndex < userWords.length) {
                output += `<span class="diff-word wrong-word">${userWords[uIndex]}</span> `;
                uIndex++;
            }
            output += "</div>";
            output += "<div style='margin-top:10px; font-size:0.8em; color:#666;'>※ 緑：正解 / <span style='color:#c0392b; text-decoration:line-through;'>赤：間違い</span> / <span style='color:#2980b9; font-weight:bold; border-bottom: 2px solid #2980b9;'>青：不足していた正解</span></div>";
            return output;
        }
    </script>
</body>
</html>




