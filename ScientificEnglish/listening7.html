<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聞き取り第7回：Climate Change（音声版）</title>
    <style>
        body {
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
            background-color: #f4f4f9;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        /* 戻るボタン */
        .back-link-btn {
            display: inline-block;
            margin-bottom: 15px;
            padding: 8px 16px;
            background-color: #95a5a6;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 0.9em;
            transition: background-color 0.2s;
        }
        .back-link-btn:hover {
            background-color: #7f8c8d;
        }

        .video-info {
            text-align: center;
            margin-bottom: 30px;
            padding: 10px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .question-card {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .q-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .q-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #2980b9;
        }
        /* 再生ボタン */
        .play-link-btn {
            background-color: #3498db; /* 音声版なので色を青に変更 */
            color: white;
            border: none;
            cursor: pointer;
            padding: 6px 15px;
            border-radius: 4px;
            font-size: 0.9em;
            display: inline-block;
            transition: background-color 0.2s;
            text-decoration: none;
        }
        .play-link-btn:hover {
            background-color: #2980b9;
        }

        .theme-text {
            font-size: 0.95em;
            color: #555;
            margin-bottom: 15px;
            background: #f0f8ff;
            padding: 10px;
            border-left: 4px solid #3498db;
        }
        textarea {
            width: 100%;
            height: 80px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1em;
            box-sizing: border-box;
            resize: vertical;
            font-family: inherit;
        }
        .controls {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .check-btn {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
        }
        .check-btn:hover {
            background-color: #219150;
        }
        .result-area {
            margin-top: 15px;
            padding: 15px;
            border: 1px solid #ddd;
            background-color: #fafafa;
            border-radius: 4px;
            display: none;
            line-height: 1.6;
        }
        
        .diff-word { margin: 0 2px; }
        .correct-word { color: #27ae60; font-weight: bold; }
        .wrong-word { color: #c0392b; text-decoration: line-through; margin-right: 4px; }
        .missing-word { color: #2980b9; font-weight: bold; border-bottom: 2px solid #2980b9; }
        .perfect { color: #27ae60; font-weight: bold; font-size: 1.2em; }
        
        .translation-toggle { font-size: 0.85em; color: #7f8c8d; cursor: pointer; text-decoration: underline; }
        .japanese-trans { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #eee; font-size: 0.9em; color: #555; display: none; }
        
        /* 音声プレーヤー埋め込みエリア（動画よりシンプルに） */
        .embedded-audio-container { 
            margin-top: 10px; 
            margin-bottom: 10px; 
            display: none; 
            background: #f1f3f4; /* 明るいグレー */
            border-radius: 30px; /* 丸みをつける */
            padding: 5px;
        }
        audio { width: 100%; display: block; outline: none; }
    </style>
</head>
<body>

    <a href="index.html" class="back-link-btn">← 一覧に戻る</a>

    <h1>聞き取り第7回：Climate Change</h1>
    
    <div class="video-info">
        <p>※ 音声ファイル（MP3）を使用しています。「この場で再生」ボタンを押すと音声が流れます。</p>
    </div>

    <div id="shared-audio-wrapper" style="display:none;">
        <audio id="main-audio" controls>
            <source src="listening7.mp3" type="audio/mp3">
            お使いのブラウザはaudioタグに対応していません。
        </audio>
    </div>

    <div id="quiz-container"></div>

    <script>
        // データ定義
        const quizData = [
            {
                id: 1,
                timeDisplay: "00:17 ～ ", 
                startSeconds: 17,
                theme: "気候変動に関する誤解について",
                correct: "Well, here's a misconception. The threat of climate change has to do with the absolute warmth of the Earth. It's not the case.",
                translation: "実は、ここに誤解がある。気候変動の脅威とは、地球の絶対的な暖かさ（温度の絶対値）にあると思われがちだが、事実はそうではない。"
            },
            {
                id: 2,
                timeDisplay: "00:46 ～ ", 
                startSeconds: 46,
                theme: "過去の気候を復元する方法（プロキシ記録）について",
                correct: "So, to reconstruct how climate changed in the distant past, prior to the period of the roughly 100 to 150 years where we have widespread historical measurements of climate variables, we need to turn to so called proxy records.",
                translation: "気候変数の広範な歴史的測定データが存在するのは過去およそ100～150年間だが、それより以前の遠い過去に気候がどう変化したかを復元するには、いわゆるプロキシ記録に頼る必要がある。"
            },
            {
                id: 3,
                timeDisplay: "02:08 ～ ", 
                startSeconds: 128,
                theme: "過去1000年間の気温変動パターン（中世温暖期と小氷期）について",
                correct: "And the pattern that it revealed was relatively warm conditions a thousand years ago, during what's sometimes called the Medieval Warm Period, and a slow cooling as we descend into the Little Ice age of the 17th, 18th and 19th centuries.",
                translation: "その曲線が明らかにしたパターンは次のようなものだった。1000年前は比較的温暖な状態（いわゆる中世の温暖期）があり、その後、17世紀、18世紀、19世紀の小氷期に向かってゆっくりと寒冷化していくというものである。"
            },
            {
                id: 4,
                timeDisplay: "02:43 ～ ", 
                startSeconds: 163,
                theme: "グラフの形状と「ホッケースティック」の喩えについて",
                correct: "In fact, if you use your imagination, that record sort of resembles a sports implement known as a hockey stick.",
                translation: "実際、想像力を働かせて見れば、その記録はスポーツ用具の「ホッケースティック」に少し似ている。"
            },
            {
                id: 5,
                timeDisplay: "03:40 ～ ", 
                startSeconds: 220,
                theme: "現在の科学的コンセンサス（「ホッケーリーグ」）について",
                correct: "But today, there's no longer a hockey stick. There is a veritable hockey league, which is to say there are many of these sorts of reconstructions of past temperatures that have been done by different teams of scientists using different data and different methods.",
                translation: "しかし今日では、もはや一本のホッケースティックだけではない。言ってみればホッケーリーグが存在する。つまり、異なる科学者チームが、異なるデータと異なる手法を使って行った、過去の気温の復元記録がたくさんあるということだ。"
            }
        ];

        const container = document.getElementById('quiz-container');
        
        quizData.forEach((q, index) => {
            const html = `
                <div class="question-card">
                    <div class="q-header">
                        <span class="q-title">第${q.id}問 (${q.timeDisplay})</span>
                        <button class="play-link-btn" onclick="playLocalAudio(${index}, ${q.startSeconds})">▶ この場で再生</button>
                    </div>
                    
                    <div id="audio-area-${index}" class="embedded-audio-container"></div>

                    <div class="theme-text">
                        <strong>テーマ:</strong> ${q.theme}
                    </div>
                    <div>
                        <textarea id="input-${index}" placeholder="ここに英語の文章を入力してください..."></textarea>
                    </div>
                    <div class="controls">
                        <button class="check-btn" onclick="checkAnswer(${index})">答え合わせ</button>
                        <span class="translation-toggle" onclick="toggleTrans(${index})">日本語訳を表示/非表示</span>
                    </div>
                    
                    <div id="result-${index}" class="result-area"></div>
                    <div id="trans-${index}" class="japanese-trans">
                        <strong>日本語訳:</strong><br>${q.translation}
                    </div>
                </div>
            `;
            container.innerHTML += html;
        });

        // ローカル音声を再生する関数（DOM移動方式）
        function playLocalAudio(index, startSeconds) {
            const audioElement = document.getElementById('main-audio');
            const wrapper = document.getElementById('shared-audio-wrapper');
            const targetArea = document.getElementById(`audio-area-${index}`);
            
            // 全ての音声エリアを一度非表示・空にする
            quizData.forEach((_, i) => {
                const area = document.getElementById(`audio-area-${i}`);
                if (i !== index && area.contains(audioElement)) {
                    wrapper.appendChild(audioElement);
                    area.style.display = 'none';
                }
                if (i !== index) area.style.display = 'none';
            });

            // 音声要素をターゲットエリアに移動
            targetArea.appendChild(audioElement);
            targetArea.style.display = 'block';

            // 時間を指定して再生
            audioElement.currentTime = startSeconds;
            audioElement.play();
        }

        function toggleTrans(index) {
            const el = document.getElementById(`trans-${index}`);
            el.style.display = (el.style.display === 'block') ? 'none' : 'block';
        }

        function checkAnswer(index) {
            const userText = document.getElementById(`input-${index}`).value.trim();
            const correctText = quizData[index].correct;
            const resultDiv = document.getElementById(`result-${index}`);

            if (!userText) {
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = '<span style="color:red;">テキストを入力してください。</span>';
                return;
            }

            if (userText === correctText) {
                resultDiv.innerHTML = '<div class="perfect">正解です！ Perfect!</div>';
                resultDiv.style.display = 'block';
                return;
            }

            let html = "<strong>判定結果:</strong><br>";
            html += generateDiffHTML(userText, correctText);

            resultDiv.style.display = 'block';
            resultDiv.innerHTML = html;
        }

        function generateDiffHTML(userStr, correctStr) {
            const clean = s => s.toLowerCase().replace(/[.,?!;:"'’]/g, "");
            const userWords = userStr.split(/\s+/);
            const correctWords = correctStr.split(/\s+/);
            let output = "<div>";
            let uIndex = 0;
            
            for (let i = 0; i < correctWords.length; i++) {
                let cWord = correctWords[i];
                let cWordClean = clean(cWord);
                
                if (uIndex >= userWords.length) {
                    output += `<span class="diff-word missing-word" title="正解: ${cWord}">${cWord}</span> `;
                    continue;
                }

                let uWord = userWords[uIndex];
                let uWordClean = clean(uWord);

                if (cWordClean === uWordClean) {
                    output += `<span class="diff-word correct-word">${cWord}</span> `;
                    uIndex++;
                } else {
                    let nextUMatch = (uIndex + 1 < userWords.length) && (clean(userWords[uIndex+1]) === cWordClean);
                    if (nextUMatch) {
                        output += `<span class="diff-word wrong-word">${uWord}</span> `;
                        output += `<span class="diff-word correct-word">${cWord}</span> `;
                        uIndex += 2; 
                    } else {
                        output += `<span class="diff-word wrong-word">${uWord}</span> `;
                        output += `<span class="diff-word missing-word">${cWord}</span> `;
                        uIndex++;
                    }
                }
            }
            
            while(uIndex < userWords.length) {
                output += `<span class="diff-word wrong-word">${userWords[uIndex]}</span> `;
                uIndex++;
            }

            output += "</div>";
            output += "<div style='margin-top:10px; font-size:0.8em; color:#666;'>※ 緑：正解 / <span style='color:#c0392b; text-decoration:line-through;'>赤：間違い</span> / <span style='color:#2980b9; font-weight:bold; border-bottom: 2px solid #2980b9;'>青：不足していた正解</span></div>";
            return output;
        }
    </script>
</body>
</html>
